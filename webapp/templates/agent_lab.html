{% extends "base.html" %}

{% block title %}Agent Lab | GTM AI Operations Hub{% endblock %}
{% block topbar_title %}Agent Lab{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
    /* Agent Lab Layout */
    .agent-lab-container {
        display: flex;
        flex-direction: row;
        height: calc(100vh - 120px);
        gap: 1.5rem;
    }

    /* Sidebar listing agents */
    .agent-sidebar {
        width: 350px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .agent-sidebar-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        background: var(--surface);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .agent-sidebar-header h2 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .agent-list {
        display: flex;
        flex-direction: column;
        padding: 0.5rem;
    }

    .agent-item {
        display: flex;
        align-items: flex-start;
        padding: 0.75rem;
        border-radius: 6px;
        text-decoration: none;
        color: var(--text-secondary);
        transition: all 0.2s;
        border: 1px solid transparent;
        margin-bottom: 0.25rem;
    }

    .agent-item:hover {
        background: var(--surface-hover);
    }

    .agent-item.active {
        background: var(--primary-light);
        color: var(--primary);
        border: 1px solid var(--primary-border);
    }

    .agent-icon {
        font-size: 1.5rem;
        margin-right: 0.75rem;
        line-height: 1;
    }

    .agent-info {
        display: flex;
        flex-direction: column;
    }

    .agent-name {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 0.2rem;
        color: var(--text-primary);
    }

    .agent-item.active .agent-name {
        color: var(--primary-dark);
    }

    .agent-desc {
        font-size: 0.85rem;
        line-height: 1.4;
        color: var(--text-tertiary);
        margin-top: 0.25rem;
    }

    /* Main Workspace for Chat */
    .agent-workspace {
        flex: 1;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .workspace-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .workspace-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .workspace-title h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }

    .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg-color);
        position: relative;
        overflow: hidden;
    }

    .chat-history {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .chat-message {
        display: flex;
        max-width: 80%;
    }

    .message-user {
        align-self: flex-end;
    }

    .message-user .message-bubble {
        background: var(--primary);
        color: white;
        border-radius: 12px 12px 0 12px;
    }

    .message-agent {
        align-self: flex-start;
        display: flex;
        gap: 0.75rem;
    }

    .message-agent .message-bubble {
        background: var(--surface);
        color: var(--text-primary);
        border: 1px solid var(--border);
        border-radius: 12px 12px 12px 0;
    }

    .message-bubble {
        padding: 0.85rem 1.25rem;
        line-height: 1.5;
        font-size: 0.95rem;
        white-space: pre-wrap;
    }

    .markdown-body {
        white-space: normal;
        /* Override pre-wrap for markdown */
    }

    .markdown-body pre {
        background: rgba(0, 0, 0, 0.05);
        padding: 0.75rem;
        border-radius: 4px;
        overflow-x: auto;
        margin: 0.5rem 0;
    }

    .markdown-body code {
        font-family: SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
        font-size: 0.85em;
        background: rgba(0, 0, 0, 0.05);
        padding: 0.2em 0.4em;
        border-radius: 3px;
    }

    .markdown-body pre code {
        background: transparent;
        padding: 0;
    }

    .markdown-body p {
        margin-bottom: 0.5rem;
        margin-top: 0;
    }

    .markdown-body ul,
    .markdown-body ol {
        margin-left: 1.5rem;
        margin-bottom: 0.5rem;
        margin-top: 0;
    }

    .markdown-body :last-child {
        margin-bottom: 0;
    }

    .chat-input-area {
        padding: 1rem 1.5rem;
        background: var(--surface);
        border-top: 1px solid var(--border);
        display: flex;
        gap: 0.5rem;
    }

    .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.95rem;
        resize: none;
        height: 48px;
        outline: none;
        transition: border-color 0.2s;
    }

    .chat-input:focus {
        border-color: var(--primary);
    }

    .chat-submitBtn {
        padding: 0 1.5rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chat-submitBtn:hover {
        background: var(--primary-dark);
    }

    .chat-submitBtn:disabled {
        background: var(--text-tertiary);
        cursor: not-allowed;
    }

    .loading-dots {
        display: flex;
        gap: 4px;
        padding: 0.5rem;
        align-items: center;
    }

    .loading-dots div {
        width: 6px;
        height: 6px;
        background: var(--text-secondary);
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .loading-dots div:nth-child(1) {
        animation-delay: -0.32s;
    }

    .loading-dots div:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes bounce {

        0%,
        80%,
        100% {
            transform: scale(0);
        }

        40% {
            transform: scale(1);
        }
    }

    /* Responsive */
    @media (max-width: 900px) {
        .agent-lab-container {
            flex-direction: column;
            height: auto;
        }

        .agent-sidebar {
            width: 100%;
            max-height: 300px;
        }

        .agent-workspace {
            height: 600px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="agent-lab-container">

    <!-- Left Sidebar: Agent List -->
    <aside class="agent-sidebar">
        <div class="agent-sidebar-header">
            <h2>Relevance AI Agents</h2>
        </div>
        <div class="agent-list">
            {% for agent in agents %}
            <a href="?agent={{ agent.id }}" class="agent-item {% if agent.id == selected_agent.id %}active{% endif %}">
                <span class="agent-icon">{{ agent.icon }}</span>
                <div class="agent-info">
                    <span class="agent-name">{{ agent.name }}</span>
                    <span class="agent-desc">{{ agent.description }}</span>
                </div>
            </a>
            {% endfor %}
        </div>
    </aside>

    <!-- Right Workspace: Chat -->
    <main class="agent-workspace">
        <div class="workspace-header">
            <div class="workspace-title">
                <span style="font-size: 1.5rem;">{{ selected_agent.icon }}</span>
                <h2>{{ selected_agent.name }}</h2>
            </div>
            <div class="workspace-actions">
                <span class="badge status-measuring"
                    style="font-size: 0.8rem; padding: 0.2rem 0.5rem; border-radius: 4px; background: var(--success-light); color: var(--success-dark);">API
                    Connect</span>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-history" id="chatHistory">
                <!-- Initial welcome message -->
                <div class="chat-message message-agent">
                    <div class="message-bubble">
                        Hello! I am the <strong>{{ selected_agent.name }}</strong>.
                        {{ selected_agent.description }}
                        How can I help you today?
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <textarea class="chat-input" id="chatInput" placeholder="Message {{ selected_agent.name }}..."
                    onkeypress="handleKeyPress(event)"></textarea>
                <button class="chat-submitBtn" id="chatSubmit" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </main>

</div>
{% endblock %}

{% block scripts %}
<script>
    const agentId = "{{ selected_agent.id }}";

    // Map our frontend IDs to the Relevance AI agent ID from the user info
    // For now we'll send all to the single configured agent_id, but the backend could route them differently
    const relevanceAgentMap = {
        "lead-icp-evaluator": "f6824156-1540-41bb-853c-d22aab2cc075",
        "gtm-workflow-analyzer": "f6824156-1540-41bb-853c-d22aab2cc075",
        "customer-expansion-evaluator": "f6824156-1540-41bb-853c-d22aab2cc075",
        "sales-intelligence-extractor": "f6824156-1540-41bb-853c-d22aab2cc075",
        "sales-opportunity-risk-analyzer": "f6824156-1540-41bb-853c-d22aab2cc075",
        "gtm-research-assistant": "f6824156-1540-41bb-853c-d22aab2cc075"
    };

    const targetRelevanceAgentId = relevanceAgentMap[agentId] || "f6824156-1540-41bb-853c-d22aab2cc075";

    function appendMessage(role, text) {
        const history = document.getElementById("chatHistory");

        const wrapper = document.createElement("div");
        wrapper.className = `chat-message message-${role}`;

        if (role === 'agent' && text === null) {
            // Add loading state
            wrapper.id = 'loadingMessage';
            wrapper.innerHTML = `
                <div class="message-bubble">
                    <div class="loading-dots">
                        <div></div><div></div><div></div>
                    </div>
                </div>
            `;
        } else {
            if (role === 'agent') {
                const parsedHTML = marked.parse(text);
                wrapper.innerHTML = `<div class="message-bubble markdown-body">${parsedHTML}</div>`;
            } else {
                const safeText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                wrapper.innerHTML = `<div class="message-bubble">${safeText}</div>`;
            }
        }

        history.appendChild(wrapper);
        history.scrollTop = history.scrollHeight;
    }

    function removeLoading() {
        const loading = document.getElementById('loadingMessage');
        if (loading) loading.remove();
    }

    async function sendMessage() {
        const input = document.getElementById("chatInput");
        const btn = document.getElementById("chatSubmit");
        const message = input.value.trim();

        if (!message) return;

        // Add user message to UI
        appendMessage('user', message);
        input.value = "";

        // Disable input while waiting
        input.disabled = true;
        btn.disabled = true;

        // Show loading indicator
        appendMessage('agent', null);

        try {
            const response = await fetch(`/api/agent-lab/${targetRelevanceAgentId}/chat`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ message: message })
            });

            removeLoading();

            const data = await response.json();

            if (response.ok && data.status === "success") {
                // Determine text output from Relevance AI response
                // Responses often consist of complex structures, but usually there's output
                let agentOutput = "Done.";
                if (data.response && data.response.output) {
                    if (data.response.output.answer) agentOutput = data.response.output.answer;
                    else if (data.response.output.message) agentOutput = data.response.output.message;
                    else if (data.response.output.text) agentOutput = data.response.output.text;
                    else agentOutput = JSON.stringify(data.response.output, null, 2);
                }
                appendMessage('agent', agentOutput);
            } else {
                appendMessage('agent', "Error: " + (data.message || "Could not connect to agent"));
            }
        } catch (error) {
            removeLoading();
            appendMessage('agent', "Network error: " + error.message);
        } finally {
            input.disabled = false;
            btn.disabled = false;
            input.focus();
        }
    }

    function handleKeyPress(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    }
</script>
{% endblock %}