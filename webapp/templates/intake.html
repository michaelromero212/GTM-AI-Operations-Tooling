{% extends "base.html" %}

{% block title %}Intake ‚Äî GTM AI Operations Hub{% endblock %}
{% block topbar_title %}Intake{% endblock %}

{% block content %}
<div class="page-header">
    <h2>üì• AI Triage Queue</h2>
    <p>Automated ingestion from üìß Email, üí¨ Slack, and ‚òÅÔ∏è Salesforce. AI-powered classification and requirements
        generation in real-time.</p>
</div>

<!-- Triage Queue Table -->
<div class="card" style="margin-bottom: 32px;">
    <div class="card-header">
        <span class="card-title">Recent Ingestions (Live)</span>
        <div style="display: flex; gap: 8px;">
            <span class="badge badge-blue">üìß 4 Pending</span>
            <span class="badge badge-purple">üí¨ 2 New</span>
        </div>
    </div>
    {% if queue %}
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Source</th>
                    <th>ID</th>
                    <th>Requester</th>
                    <th>Team</th>
                    <th>AI Triage Summary</th>
                    <th>Urgency</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for row in queue %}
                <tr>
                    <td>
                        {% if 'Sales' in row.requester_team %}üí¨ Slack
                        {% elif 'Customer' in row.requester_team %}üìß Email
                        {% else %}‚òÅÔ∏è SFDC{% endif %}
                    </td>
                    <td><a href="/builder/{{ row.id }}" class="card-link">{{ row.id }}</a></td>
                    <td>{{ row.requester_name }}</td>
                    <td>{{ row.requester_team }}</td>
                    <td>{{ row.triage_summary or 'Awaiting AI Analysis...' }}</td>
                    <td>
                        {% if row.urgency == 'CRITICAL' %}<span class="badge badge-red">{{ row.urgency }}</span>
                        {% elif row.urgency == 'HIGH' %}<span class="badge badge-orange">{{ row.urgency }}</span>
                        {% elif row.urgency == 'MEDIUM' %}<span class="badge badge-yellow">{{ row.urgency }}</span>
                        {% else %}<span class="badge badge-blue">{{ row.urgency }}</span>{% endif %}
                    </td>
                    <td>
                        <a href="/builder/{{ row.id }}" class="btn btn-sm btn-primary">Open Builder</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state"><span class="icon">üì≠</span>
        <h3>No active ingestions</h3>
        <p>The queue is currently empty. Automated syncs run every 5 minutes.</p>
    </div>
    {% endif %}
</div>

<div class="grid-2">
    <!-- Manual Entry Form (Pivot to secondary) -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Manual Request Entry</span>
        </div>
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">Use this for direct field requests or
            offline submissions.</p>
        <form method="POST" action="/intake" id="intake-form">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Requester</label>
                    <input type="text" name="requester_name" class="form-input" placeholder="e.g. Sarah Chen" required>
                </div>
                <div class="form-group">
                    <label class="form-label">GTM Team</label>
                    <select name="requester_team" class="form-select" required>
                        <option value="">Select team‚Ä¶</option>
                        <option value="Sales (SDR)">Sales (SDR)</option>
                        <option value="Sales (AE)">Sales (AE)</option>
                        <option value="Sales (Manager)">Sales (Manager)</option>
                        <option value="Customer Success">Customer Success</option>
                        <option value="RevOps">RevOps</option>
                        <option value="Marketing Ops">Marketing Ops</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Pain Point Detail</label>
                <textarea name="pain_point" class="form-textarea" rows="3" placeholder="Describe the manual work..."
                    required></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Confluent GTM Stage</label>
                    <select name="workflow_stage" class="form-select" required>
                        <option value="">Select stage‚Ä¶</option>
                        <option value="Pipeline Generation">Pipeline Generation</option>
                        <option value="Deal Execution">Deal Execution</option>
                        <option value="Onboarding & Adoption">Onboarding & Adoption</option>
                        <option value="Expansion & Renewal">Expansion & Renewal</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Time Saved (hrs/wk)</label>
                    <input type="number" name="manual_time_hours" class="form-input" step="0.5" min="0.5" required>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-sm" style="width: 100%; margin-top: 8px;">
                üß† Process with AI Agent
            </button>
        </form>
    </div>

    <!-- Triage Logic Guide -->
    <div style="display: flex; flex-direction: column; gap: 20px;">
        <div class="card">
            <div class="card-header">
                <span class="card-title">Operational Rigor: Triage Model</span>
                <span class="card-icon">üèóÔ∏è</span>
            </div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                <p>Every ingestion is processed through a three-stage AI gate:</p>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li><strong>Extraction:</strong> Pain points mapped to CRM objects.</li>
                    <li><strong>Impact Scoring:</strong> Priority assigned by labor cost + deal influence.</li>
                    <li><strong>Blueprint Gen:</strong> Auto-generating workflow logic for Relex/LangGraph.</li>
                </ul>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">Ingestion Health</span>
                <span class="card-icon">üü¢</span>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px; font-size: 12px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>üìß Outlook/GCal Sync</span>
                    <span style="color: var(--accent-green); font-weight: 600;">ACTIVE</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>üí¨ Slack #gtm-ops-live</span>
                    <span style="color: var(--accent-green); font-weight: 600;">CONNECTED</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>‚òÅÔ∏è Salesforce Metadata</span>
                    <span style="color: var(--accent-green); font-weight: 600;">SYNCED</span>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Results Panel -->
{% if result %}
<div class="result-panel success fade-in" style="margin-top: 24px;">
    <div class="result-header">
        <span>‚úÖ</span>
        <h3>Request Submitted ‚Äî {{ result.request_id }}</h3>
        <span class="badge {% if result.source == 'llm' %}badge-green{% else %}badge-yellow{% endif %}">
            {{ 'AI Triaged' if result.source == 'llm' else 'Mock Triage' }}
        </span>
    </div>

    <div class="result-meta">
        <span>‚è± Triage latency: {{ result.latency_ms }}ms</span>
    </div>

    <!-- Triage Results -->
    <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px;">
        <div class="stat-card" style="padding: 14px;">
            <div class="stat-label">GTM Stage</div>
            <div style="font-weight: 600; color: var(--accent-blue);">{{ result.triage.gtm_stage }}</div>
        </div>
        <div class="stat-card" style="padding: 14px;">
            <div class="stat-label">Complexity</div>
            <div style="font-weight: 600; color: var(--accent-purple);">{{ result.triage.complexity }}</div>
        </div>
        <div class="stat-card" style="padding: 14px;">
            <div class="stat-label">Approach</div>
            <div style="font-weight: 600; color: var(--accent-green);">{{ result.triage.approach }}</div>
        </div>
        <div class="stat-card" style="padding: 14px;">
            <div class="stat-label">Priority</div>
            <div style="font-weight: 600; color: var(--accent-orange);">{{ result.triage.priority_score }} / 10</div>
        </div>
    </div>

    <!-- Requirements Brief -->
    {% if result.requirements %}
    <div class="card" style="margin-top: 16px; background: var(--bg-secondary);">
        <div class="card-header">
            <span class="card-title">üìù Generated Requirements Brief</span>
        </div>
        <div class="result-body">
            {% if result.requirements.title %}<p><strong>Title:</strong> {{ result.requirements.title }}</p>{% endif %}
            {% if result.requirements.problem_statement %}<p style="margin-top: 8px;"><strong>Problem:</strong> {{
                result.requirements.problem_statement }}</p>{% endif %}
            {% if result.requirements.estimated_effort %}<p style="margin-top: 8px;"><strong>Effort:</strong> {{
                result.requirements.estimated_effort }}</p>{% endif %}
            {% if result.requirements.success_metrics %}
            <p style="margin-top: 8px;"><strong>Success Metrics:</strong></p>
            <ul style="padding-left: 20px; margin-top: 4px;">
                {% for m in result.requirements.success_metrics %}<li>{{ m }}</li>{% endfor %}
            </ul>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div style="margin-top: 16px; display: flex; gap: 12px;">
        <a href="/backlog" class="btn btn-primary">View in Backlog ‚Üí</a>
        <a href="/builder/{{ result.request_id }}" class="btn btn-secondary">Open Builder ‚Üí</a>
    </div>
</div>
{% endif %}
{% endblock %}